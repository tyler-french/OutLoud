actions:
  - name: "Test all targets"
    triggers:
      push:
        branches:
          - "main"
      pull_request:
        branches:
          - "*"
    steps:
      - run: "sudo apt-get update && sudo apt-get install -y ffmpeg libsndfile1"
      - run: "bazel run //:ruff -- check"
      - run: "bazel run //:ruff -- format --check"
      - run: "bazel test --config=ci //..."
      - run: |
        timeout 30 bazel run --config=ci //:app &
        APP_PID=$!
        sleep 15
        curl -f http://localhost:5001 || exit 1
        kill $APP_PID 2>/dev/null || true
